!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports["p5.anaglyph"]=i():t["p5.anaglyph"]=i()}(self,(()=>(()=>{"use strict";var t={};function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function e(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,(void 0,s=function(t,e){if("object"!==i(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var a=r.call(t,"string");if("object"!==i(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(a.key),"symbol"===i(s)?s:String(s)),a)}var s}(t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})(t);var r=new(function(){function t(){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.divergence=1,this.swapLeftRight=-1,this.adjustTargetFactor=1,this.useAsymmetricFrustum=!0,this.cameraDivergenceX=0,this.cameraDivergenceY=0,this.cameraDivergenceZ=0,this.frustrumSkew=0,this.RAD_TO_DEG=57.29577951308232,this.LEFT_IMG=0,this.RIGHT_IMG=1,this.shaderLoaded=!1,this.fc=-1}var i,r;return i=t,r=[{key:"init",value:function(){frameCount!=this.fc&&(this.fc=frameCount,this.config={cameraPositionX:0,cameraPositionY:0,cameraPositionZ:this.pInst.height/2/this.pInst.tan(this.pInst.PI/6),cameraTargetX:0,cameraTargetY:0,cameraTargetZ:0,cameraUpX:0,cameraUpY:1,cameraUpZ:0,frustumLeft:-this.pInst.width/2,frustumRight:this.pInst.width/2,frustumBottom:-this.pInst.height/2,frustumTop:this.pInst.height/2,frustumNear:0,frustumFar:max(this.pInst.width,this.pInst.height),fovy:PI/3},this.recalculateCameraSettings(),this.imgLeft=createGraphics(this.pInst.width,this.pInst.height,WEBGL),this.imgRight=createGraphics(this.pInst.width,this.pInst.height,WEBGL),this.output=createGraphics(this.pInst.width,this.pInst.height,WEBGL),this.theShader=this.output.createShader("#ifdef GL_ES \nprecision mediump float; \n#endif \nattribute vec3 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main() {vTexCoord = aTexCoord;vec4 positionVec4 = vec4(aPosition, 1.0);positionVec4.xy = positionVec4.xy * 2.0 - 1.0;gl_Position = positionVec4;}","#ifdef GL_ES \nprecision mediump float; \n#endif \nvarying vec2 vTexCoord;uniform vec2 u_resolution;uniform sampler2D mapLeft;uniform sampler2D mapRight;mat3 colorMatrixLeft = mat3(0.456100, - 0.0400822, - 0.0152161,0.500484, - 0.0378246, - 0.0205971,0.176381, - 0.0157589, - 0.00546856);mat3 colorMatrixRight = mat3(- 0.0434706, 0.378476, - 0.0721527,- 0.0879388, 0.73364, - 0.112961,- 0.00155529, - 0.0184503, 1.2264);float lin( float c ) {return c <= 0.04045 ? c * 0.0773993808 :pow( c * 0.9478672986 + 0.0521327014, 2.4 );}vec4 lin( vec4 c ) {return vec4( lin( c.r ), lin( c.g ), lin( c.b ), c.a );}float dev( float c ) {return c <= 0.0031308 ? c * 12.92: pow( c, 0.41666 ) * 1.055 - 0.055;}void main() {vec2 uv = vTexCoord;vec4 colorL = lin( texture2D( mapLeft, uv ) );vec4 colorR = lin( texture2D( mapRight, uv ) );vec3 color = clamp(colorMatrixLeft * colorL.rgb +colorMatrixRight * colorR.rgb, 0., 1. );gl_FragColor = vec4(dev( color.r ), dev( color.g ), dev( color.b ),max( colorL.a, colorR.a ) );}"),this.shaderLoaded=!0)}},{key:"draw",value:function(t){this.theShader&&this.shaderLoaded?(this.drawScene(this.LEFT_IMG,this.imgLeft,t),this.drawScene(this.RIGHT_IMG,this.imgRight,t),this.updateShader()):(this.drawScene(this.LEFT_IMG,this.imgLeft,t),image(this.imgLeft,-this.pInst.width/2,-this.pInst.height/2))}},{key:"setDivergence",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.divergence=t}},{key:"updateShader",value:function(){this.theShader.setUniform("u_resolution",[this.pInst.width,this.pInst.height]),this.theShader.setUniform("mapLeft",this.imgLeft),this.theShader.setUniform("mapRight",this.imgRight),this.output.clear(),this.output.shader(this.theShader),this.output.rect(0,0,this.pInst.width,this.pInst.height),this.pInst.image(this.output,-this.pInst.width/2,-this.pInst.height/2)}},{key:"drawStereoImages",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.theShader&&this.shaderLoaded?(this.drawImage(t,this.imgLeft,e,r),this.drawImage(i,this.imgRight,e,r),this.updateShader()):this.drawImage(t,this.imgLeft)}},{key:"drawImage",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t&&(i.push(),i.clear(),i.translate(e,r),i.scale(1,-1),i.image(t,0,0),i.pop())}},{key:"drawScene",value:function(t,i,e){i.push(),i.clear(),this.getCamera(t,i),e(i),i.pop()}},{key:"recalculateCameraSettings",value:function(){this.perspective();var t=this.adjustTargetFactor*(this.config.cameraPositionX-this.config.cameraTargetX),i=this.adjustTargetFactor*(this.config.cameraPositionY-this.config.cameraTargetY),e=this.adjustTargetFactor*(this.config.cameraPositionZ-this.config.cameraTargetZ),r=-this.swapLeftRight*this.divergence/(this.config.fovy*this.RAD_TO_DEG);this.cameraDivergenceX=(i*this.config.cameraUpZ-this.config.cameraUpY*e)*r,this.cameraDivergenceY=(e*this.config.cameraUpX-this.config.cameraUpZ*t)*r,this.cameraDivergenceZ=(t*this.config.cameraUpY-this.config.cameraUpX*i)*r;var a=Math.sqrt(t*t+i*i+e*e),s=Math.sign(this.swapLeftRight*this.divergence)*Math.sqrt(this.cameraDivergenceX*this.cameraDivergenceX+this.cameraDivergenceY*this.cameraDivergenceY+this.cameraDivergenceZ*this.cameraDivergenceZ);this.frustrumSkew=s*this.config.frustumNear/a}},{key:"getCamera",value:function(t,i){this.useAsymmetricFrustum?this.drawAsymmetricFrustrum(t,i):this.drawSymmetricFrustrum(t,i)}},{key:"drawAsymmetricFrustrum",value:function(t,i){t==this.LEFT_IMG?(i.camera(this.config.cameraPositionX+this.cameraDivergenceX,this.config.cameraPositionY+this.cameraDivergenceY,this.config.cameraPositionZ+this.cameraDivergenceZ,this.config.cameraTargetX+this.cameraDivergenceX,this.config.cameraTargetY+this.cameraDivergenceY,this.config.cameraTargetZ+this.cameraDivergenceZ,this.config.cameraUpX,this.config.cameraUpY,this.config.cameraUpZ),i.frustum(this.config.frustumLeft-this.frustrumSkew,this.config.frustumRight-this.frustrumSkew,this.config.frustumBottom,this.config.frustumTop,this.config.frustumNear,this.config.frustumFar)):t==this.RIGHT_IMG&&(i.camera(this.config.cameraPositionX-this.cameraDivergenceX,this.config.cameraPositionY-this.cameraDivergenceY,this.config.cameraPositionZ-this.cameraDivergenceZ,this.config.cameraTargetX-this.cameraDivergenceX,this.config.cameraTargetY-this.cameraDivergenceY,this.config.cameraTargetZ-this.cameraDivergenceZ,this.config.cameraUpX,this.config.cameraUpY,this.config.cameraUpZ),i.frustum(this.config.frustumLeft+this.frustrumSkew,this.config.frustumRight+this.frustrumSkew,this.config.frustumBottom,this.config.frustumTop,this.config.frustumNear,this.config.frustumFar))}},{key:"drawSymmetricFrustrum",value:function(t,i){t==LEFT_IMG?i.camera(this.config.cameraPositionX+this.cameraDivergenceX,this.config.cameraPositionY+this.cameraDivergenceY,this.config.cameraPositionZ+this.cameraDivergenceZ,this.config.cameraTargetX,this.config.cameraTargetY,this.config.cameraTargetZ,this.config.cameraUpX,this.config.cameraUpY,this.config.cameraUpZ):t==this.RIGHT_IMG&&i.camera(this.config.cameraPositionX-this.cameraDivergenceX,this.config.cameraPositionY-this.cameraDivergenceY,this.config.cameraPositionZ-this.cameraDivergenceZ,this.config.cameraTargetX,this.config.cameraTargetY,this.config.cameraTargetZ,this.config.cameraUpX,this.config.cameraUpY,this.config.cameraUpZ)}},{key:"perspective",value:function(){var t=this.pInst.height/2/Math.tan(60*PI/360),i=PI/3,e=this.pInst.width/this.pInst.height,r=t/10,a=10*t,s=r*Math.tan(i/2),c=-s,o=c*e,n=s*e;this.frustum(o,n,c,s,r,a)}},{key:"frustum",value:function(t,i,e,r,a,s){this.config.frustumLeft=t,this.config.frustumRight=i,this.config.frustumBottom=e,this.config.frustumTop=r,this.config.frustumNear=a,this.config.frustumFar=s,this.config.fovy=2*Math.atan(r/a)}},{key:"resize",value:function(){this.recalculateCameraSettings()}}],r&&e(i.prototype,r),Object.defineProperty(i,"prototype",{writable:!1}),t}());return p5.prototype.createAnaglyph=function(t){return r.pInst=t,r.init(),r},t})()));